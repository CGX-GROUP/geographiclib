# -*- Makefile -*-

# ssh -t karney,geographiclib@shell.sourceforge.net create
# git: /home/git/p/geographiclib/code.git

USER=karney
STAGE=$(HOME)/web
WEBSTAGE=$(STAGE)/geographiclib-web
DATASTAGE=$(STAGE)/geographiclib-files
SCRIPTSTAGE=$(WEBSTAGE)/htdocs/scripts

geodesic-papers/biblio.html: geodesic-biblio.txt biblio.sh
	sh biblio.sh $< > $@
JS_MODULES=Math Geodesic GeodesicLine PolygonArea DMS Interface
JS_SOURCES=$(patsubst %,doc/scripts/GeographicLib/%.js,$(JS_MODULES))
doc/scripts/geographiclib.js: $(JS_SOURCES)
	sh js-compress.sh $^ > $@

pack-js: doc/scripts/geographiclib.js

distrib-html: geodesic-papers/biblio.html
	rsync -av --exclude .svn --exclude '.git*' --exclude '*~' --exclude '.#*' --exclude '#*' --delete --delete-excluded index.html tm.html tm-addenda.html tm-grid.kmz geod.html geod-addenda.html bessel-errata.html jacobi-errata.html *-figs.pdf geodesic-papers $(WEBSTAGE)/htdocs/
	rsync --delete -av -e ssh $(WEBSTAGE)/htdocs $(USER),geographiclib@web.sourceforge.net:./

distrib-doc:
	rsync --delete -av -e ssh $(WEBSTAGE)/htdocs $(USER),geographiclib@web.sourceforge.net:./

distrib-files:
	rsync -av --exclude .svn --exclude '.git*' --delete distrib testdata geoids-distrib gravity-distrib magnetic-distrib $(DATASTAGE)/
	rsync --exclude '*~' --exclude '#*' --exclude '.#*' --exclude .svn --exclude '.git*' --delete --delete-excluded -av -e ssh $(DATASTAGE)/{distrib,testdata,{geoids,gravity,magnetic}-distrib} $(USER)@frs.sourceforge.net:/home/frs/project/geographiclib/

distrib-cgi:
	for f in GeoConvert GeodSolve GeoidEval Planimeter RhumbSolve printlogs Geod; do \
	  a=cgi-bin/$$f.cgi; b=$(WEBSTAGE)/cgi-bin/$$f; \
	  cmp $$a $$b > /dev/null || install $$a $$b; done
	for f in utils; do \
	  a=cgi-bin/$$f.sh; b=$(WEBSTAGE)/cgi-bin/$$f.sh; \
	  cmp $$a $$b > /dev/null || install -m 644 $$a $$b; done
	rsync --exclude '*~' --exclude '#*' --exclude '.#*' --delete --delete-excluded -av -e ssh $(WEBSTAGE)/{cgi-bin,geoids} $(USER),geographiclib@web.sourceforge.net:./

distrib-js: doc/scripts/geographiclib.js
	v=`grep ' Version: ' doc/scripts/geographiclib.js |cut -f4 -d' '`; \
	for f in geod-calc.html geod-google{,-instructions}.html \
	geographiclib.js \
	GeographicLib/{Math,Geodesic{,Line},PolygonArea,DMS,Interface}.js; do \
	  a=doc/scripts/$$f; b=$(SCRIPTSTAGE)/test/$$f; \
	  test $$f = geographiclib.js && \
	  b=$(SCRIPTSTAGE)/test/geographiclib-$$v.js; \
	  sed s%/scripts/geographic%/scripts/test/geographic% $$a > $$b.new; \
	  if cmp $$b.new $$b > /dev/null 2>&1; then \
	  rm $$b.new; else mv $$b.new $$b; fi; \
        done; \
	rm -f $(SCRIPTSTAGE)/test/geographiclib.js; \
	ln -s geographiclib-$$v.js $(SCRIPTSTAGE)/test/geographiclib.js
	rsync --exclude '*~' --exclude '.#*' --exclude '#*' --delete --delete-excluded -av -e ssh $(SCRIPTSTAGE)/test/ $(USER),geographiclib@web.sourceforge.net:./htdocs/scripts/test/

install-js:
	find $(SCRIPTSTAGE)/test -type f -printf '%P\n' | \
	while read f; do \
	  a=$(SCRIPTSTAGE)/test/$$f; \
	  b=$(SCRIPTSTAGE)/$$f; \
	  sed s%/scripts/test/geographic%/scripts/geographic% $$a > $$b.new; \
	  if cmp $$b.new $$b > /dev/null 2>&2; then \
	  rm $$b.new; else mv $$b.new $$b; fi; \
	done
	t=`find $(SCRIPTSTAGE)/test/geographiclib.js -printf '%l'`; \
	rm -f $(SCRIPTSTAGE)/geographiclib.js; \
	ln -s $$t $(SCRIPTSTAGE)/geographiclib.js
#	rsync --exclude '*~' --exclude '.#*' --exclude '#*' --delete --delete-excluded -av -e ssh $(SCRIPTSTAGE)/ $(USER),geographiclib@web.sourceforge.net:./htdocs/scripts/

distrib-python: python/setup.py
	cd python && python setup.py sdist --formats=gztar,zip upload

TAGS:
	ls include/GeographicLib/*hpp src/*.cpp tools/*.cpp | xargs etags

.PHONY: distrib-html distrib-files distrib-cgi distrib-js distrib-python TAGS
